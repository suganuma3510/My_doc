## Solutions Architect ケース問題

- [Solutions Architect ケース問題](#solutions-architect-ケース問題)
- [AWSアカウントの権限周り](#awsアカウントの権限周り)
  - [クロスアカウントによる認証](#クロスアカウントによる認証)
  - [各オンプレミスユーザーのログインアカウントからAWSアカウントにログインする](#各オンプレミスユーザーのログインアカウントからawsアカウントにログインする)
  - [組織間のアカウント移動](#組織間のアカウント移動)
- [ネットワーク設計](#ネットワーク設計)
  - [クライアント証明書を使用したHTTPSアクセスの認証](#クライアント証明書を使用したhttpsアクセスの認証)
- [デプロイメント要件](#デプロイメント要件)
  - [ブルーグリーンデプロイメント](#ブルーグリーンデプロイメント)
  - [ローリングデプロイメント](#ローリングデプロイメント)
- [移行](#移行)
  - [6つの移行戦略「６R」](#6つの移行戦略６r)
  - [データ移行](#データ移行)
- [コスト最適化](#コスト最適化)
  - [各部門ごとに請求](#各部門ごとに請求)
  - [コスト配分タグを使用した追跡](#コスト配分タグを使用した追跡)
- [セキュリティ](#セキュリティ)
  - [AWSリソースの継続的な評価、監査、監視](#awsリソースの継続的な評価監査監視)
  - [リソースの制限](#リソースの制限)
- [アナリティクス](#アナリティクス)
  - [ログ分析](#ログ分析)
- [参考](#参考)

## AWSアカウントの権限周り

### クロスアカウントによる認証
- ロールによる認証  
アカウントをまたいだリソースへのアクセスを許可するにはIAMロールを使用して権限を委任する。  
IAMロールを使用することで、認証情報を共有することなくリソースへのアクセスが可能。  
ロール作成時に、別のAWSアカウントを指定し、ポリシーをアタッチする。  
またロールの信頼ポリシー設定時に外部ID（任意の識別子）を指定することで、第三者の組織にアクセスされることを防ぐことができる。

- リソースベースの認証  
現在のユーザーに与えられているアクセス許可を保持したまま、他アカウントのリソースにアクセスするには、リソースベースによるアカウントをまたいだアクセス許可をする必要がある。  
これにより、別アカウントのリソースと元アカウントのリソースにアクセスすることができる。

### 各オンプレミスユーザーのログインアカウントからAWSアカウントにログインする
オンプレミスからのログインの場合、OAuth2.0はGooGleやFacebookなどのパブリックIDプロバイダーとのWeb Identity Federationで使用される認証のため、オンプレミスの場合はSAML2.0準拠のIDプロバイダーを使用する。  
SAMLで認証しSTSを使用して一時的な視覚情報を取得する。その後、SSOエンドポイントを介してフェデレーションアクセスを実現する。

### 組織間のアカウント移動
Organizationsで組織間のアカウント移動を行うには、古い組織からメンバーアカウントを削除し、新しい組織から招待を送る必要がある。

## ネットワーク設計
### クライアント証明書を使用したHTTPSアクセスの認証
ELB、CloudFrontはクライアント証明書の認証をサポートしていない。

## デプロイメント要件
### ブルーグリーンデプロイメント
EC2、オンプレミス、Lambda関数、ECSで使用可能なデプロイ方法。  
以下の手順でデプロイを行う。
1. 稼働中の環境とは別にプライベートな新しい環境を立ち上げる。
2. 新しい環境にデプロイし、動作検証等を行う。
3. 問題が発生した場合は修正し、2 に戻る。問題がなければ、新しい環境をユーザーに開放し、古い環境をアクセスできないようにする。
4. ユーザーが利用中に問題が発生した場合は、再度古い環境を開放し、新しい環境へアクセスできないようにする。

メリット
- 無停止
- 本番環境でテストが可能
- デプロイ時に縮退しない

デメリット
- 一時的に2倍のリソースが必要
- 容易にアクセス制御が可能なネットワーク設備が必要

デプロイ中にトラフィックを移行する方法
- Canary  
2回で移行され、1回目から2回目までの間隔を指定できる。  
例：最初の増分でトラフィックの10％をシフトし、残りの90％は5分後に展開といった指定ができる。
- Linear  
毎回同じ間隔（分単位）で移行し、間隔はオプションから指定する。  
例：すべてのトラフィックがシフトするまで、トラフィックの10％を毎分シフトする
- All-at-once（一括）  
すべてのトラフィックを元のECSタスクセットから更新済みECSタスクセットに同時に移行する。

- Beanstalk  
Swap environment URLs（環境URLのスナップ）を使用してブルーグリーンデプロイを行うことができる。
個別の環境に新しいバージョンをデプロイし、2つの環境のCNAMEを入れ替えてリダイレクトを行う。

### ローリングデプロイメント
以下の手順でデプロイを行う。
1. 稼働中の環境が複数台ある場合に、1〜複数台のインスタンスをLBから切り離す。
2. 切り離した環境にデプロイし、動作検証等を行う。
3. 問題が発生した場合は修正し、2 に戻る。問題がなければ、切り離したインスタンスをLBに接続する。
4. 以上の手順をデプロイを行なっていないインスタンスに対して繰り返し行う。

メリット
- 無停止
- 本番環境でテストが可能
- デプロイ時にリソースを増やす必要がない

デメリット
- デプロイ時に衰退する
- 新しい環境と古い環境が混在するタイミングがある

## 移行
### 6つの移行戦略「６R」  
1. Rehost (再ホスティング)  
現在の環境をそのままクラウド移行。移行ツールなども利用する事ができる。
例：オンプレミスのMySQLデータベースからAWSのEC2 on MySQLへ移行

2. Replatform (プラットフォーム変換)
移行する際に、クラウド環境に合わせ、プラットフォームを最適化する。  
また、一部システムをAWSマネージドサービスへ変換する。
例：オンプレミスのMySQLデータベースからAWSのRDS for MySQLへ移行

3. Repurchase (購入)
現在のシステムやアプリケーションの使用を廃止し、別のSaaS製品などに移行する。

4. Refactor/Re-architect (クラウド・ネイティブ化)
現在のシステムやアプリケーション全体を見直し再設計した上で移行する。  
最も難易度が高いが、クラウドの特性を生かす事ができる。  
例：大規模なアプリケーションをマイクロサービスに分割など

5. Retire (廃棄・削除)
不要なシステム・アプリケーションの使用を停止または廃止する。

6. Retain (現状維持)
移行が不要、もしくは不可能と判断した際にオンプレミス環境のプラットフォームやシステムを変更せず、そのまま稼働させる。

### データ移行
- 大規模なデータベースの移行  
SnowballとAWS DMSを使用することで、高速に移行することができる。  
Edgeデバイスを使用する際は以下のプロセスが必要。
1. AWS SCTを使用して、Edgeデバイスに移動
2. AWSにデバイスを送付し、データをS3バケットにロードする
3. AWS DMSがS3からデータをターゲットデータストアに移行する

- ダウンタイムを最小限に抑えたデータベースの移行  
AWS DMSのレプリケーションインスタンスを作成し、移行することで最低限のダウンタイムで移行することができる。

## コスト最適化
### 各部門ごとに請求
タグを使用しているAWSリソースを整理し、コスト配分タグを使用して追跡する事ができる。  
またタグが適切なルールで付与されているかをConfigのConfig Rulesを使用して監視する事ができる。
Cost Explorerを使用してタグごとにフィルタリングし、各部門ごとに利用料を確認する。

### コスト配分タグを使用した追跡
Billing and Cost Management（請求ダッシュボード）コンソールで、AWS生成タグを有効にすることで作成されたリソースにタグが適用される。  
コスト配分タグのaws:createdByを使用した場合、誰がリソースを作成したのかを追跡する事ができる。  
また、タグエディタを使用することで既存のリソースのタグを修正することができる。

## セキュリティ
### AWSリソースの継続的な評価、監査、監視
AWS Configを使用することでリソースの作成、変更、削除を継続的に評価できる。  
AWS ConfigカスタムルールをLambdaと関連づけ、リソースがルールに準拠しているかの評価を自動化できる。  
またCloudWatch Eventsを利用することでほぼリアルタイムの監査、監視ができる。

### リソースの制限
- 承認されたAMI  
IMAポリシーを使用して、タグづけされたAMIのみ起動を制限することができる。  
またAWS Configを使用することで、未承認のAMIで起動されたインスタンスをチェックすることができる。

## アナリティクス

### ログ分析
- ESを使用したログ分析  
複数アカウントのCloudTrailログとVPCフローログを単一の集中型S3にデータを送信する。
Lambdaを使用してS3からESにデータを読み込むことで、ほぼリアルタイムのデータ分析が可能になる。

- コンポーネント遅延によるタイムアウトの分析  
X-RayおよびCloudWatch Logsを使用してレイテンシー、所要時間追跡の解析を行う。

- ログの遅延  
CloudWatch Logsはリアルタイムログを提供するが、CloudTrailは通常15分遅れてログを収集する。

## 参考
- [AWS WEB問題集で学習しよう](https://aws.koiwaclub.com/)
- 『AWS認定ソリューションアーキテクト－プロフェッショナル～試験特性から導き出した演習問題と詳細解説～』