# Dockerとは
Docker社が開発している、コンテナ型の仮想環境を作成、配布、実行するためのプラットフォーム

[Dockerハンズオン](https://shimo5.me/post/2020-09-07/)

### コンテナ型

現在の主流。アプリケーション・ミドルウェア・OSなどのインフラ環境を一つのコンテナとしてまとめる。それぞれのコンテナがホストOSを共有して稼働するため、他の仮想化と比べるとサーバの起動や処理なども高速。ホストOSと異なるOSのコンテナを作ることができない。
仮想化ソフトウェアの例：Dockerなど

#### コンテナ仮想化のメリット

- ビルド、デプロイも高速
- オーバーヘッドが少ない
- プラットフォームやハードウェアからの隔離環境
- ラップトップで動いているものをそのままサーバに持っていける

コンテナ型の仮想環境を構築する上で欠かせないツール
Docker
コンテナ型のアプリケーション実行環境のこと。Linux上で動作する。（WindowsやMacでは裏でLinuxの仮想環境が構築されている）

特徴
開発環境を共有できる
Docker Hubと呼ばれるレジストリがある
ホストがライブラリやミドルウェアで汚れない

dockerが利用されているサービス
AbemaTV・アメーバブログ・Pokemon Goなど

Dockerfile　書き方

FROM
ベース（親）画像を指定します。
LABEL
メタデータを提供します。 メンテナ情報を含めるのに良い場所です。
ENV
永続的な環境変数を設定します。
RUN
コマンドを実行してイメージレイヤを作成します。 パッケージをコンテナにインストールするために使用されます。
COPY
ファイルとディレクトリをコンテナにコピーします。
ADD
ファイルとディレクトリをコンテナにコピーします。 ローカルの.tarファイルをアンパックできます。
CMD
実行中のコンテナにコマンドと引数を提供します。 パラメータは上書きできます。 CMDは1つだけです。
WORKDIR
あとに続く説明の作業ディレクトリを設定します。
ARG
ビルド時にDockerに渡す変数を定義します。
ENTRYPOINT
実行中のコンテナにコマンドと引数を提供します。 引数は存続します。
EXPOSE
ポートを公開します。
VOLUME
永続データにアクセスして保存するためのディレクトリマウントポイントを作成します。


RUN - イメージ作成時に実行される
CMD - コンテナ実行時に実行される

Dockerイメージ
Docker Image はDockerfileによって作成される特定の環境のスナップショット。
イメージを動かしたものがコンテナ。


Docker Compose

docker-compose - 入門 Docker

version: '3.7'

services:
  nginx:
    build:
      context: .
      dockerfile: docker/nginx/Dockerfile
    volumes:
      - ./public:/var/www/html/public:ro
    ports:
      - 8080:80
    environment:
      PHP_HOST: app

  app:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env.example
    # volumes:
    #   - .:/var/www/html:cached

  mysql:
    image: mysql:5.7
    volumes:
      - ./mysql:/var/lib/mysql:delegated
    command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci
    environment:
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
    ports:
      - 13306:3306


version¶
docker-composeのバージョンを指定します。
特にこだわりがなければ最新のものを記述するようにしましょう。
version: '3.7'


services¶
起動するコンテナの定義を行います。
このdocker-compose.yamlでは nginx , app , mysql の3つが定義されています。
services:
  nginx:


IMAGE¶
コンテナを起動するDocker Image を指定します。
image: mysql:5.7


build¶
docker buildの実行情報を記述します。
ここで定義された情報を元にDockerをビルドし、そのビルドしたイメージ使用してコンテナを起動します。
image もしくは build どちらかを記述する必要があります。
コマンドの場合、 docker build -f docker/nginx/Dockerfile . と同一です。
build:
　# docker-compose.ymlから見た、プロジェクトのルートディレクトリへの相対パス
  context: .
　# contextで設定したディレクトリから見た、実行対象のDockerfileへの相対パス
  dockerfile: docker/nginx/Dockerfile


volumes¶
ボリュームのマウントを行います。 コマンドの場合、 -v $(pwd)/public:/var/www/html/public:ro <IMAGE ID> オプションと同一です。
volumes:
  - ./public:/var/www/html/public:ro


ports¶
ポートの開放を行います。
左にホストのポートを、右にコンテナのポートを指定します。
コマンドの場合、 -p 8080:80 オプションと同一です。
ports:
  - 8080:80


environment¶
起動するコンテナへ環境変数を定義します。
コマンドの場合、 -e PHP_HOST=app オプションと同一です。
environment:
  PHP_HOST: app


env_file¶
ファイルに定義された環境変数を読み取り、コンテナへ定義します。
env_file:
  - .env.example


command¶
Dockerfileで定義されている CMD の上書きを行います。
command: mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_general_ci

